<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sondage Soir√©e üéâ</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Nunito', sans-serif;
      background: #f0f4ff;
      min-height: 100vh;
      padding: 24px 16px 48px;
    }

    .container {
      max-width: 580px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: white;
      border-radius: 20px;
      padding: 24px;
      box-shadow: 0 2px 16px rgba(0,0,60,.07);
    }

    .card-title {
      font-size: 13px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: #aab;
      margin-bottom: 14px;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .main-title {
      font-size: 26px;
      font-weight: 800;
      color: #1a1a3a;
    }
    .main-subtitle { font-size: 14px; color: #888; margin-top: 4px; }

    /* ‚îÄ‚îÄ Name input ‚îÄ‚îÄ */
    .name-input {
      width: 100%;
      padding: 13px 16px;
      border: 2px solid #e8eaf6;
      border-radius: 14px;
      font-family: 'Nunito', sans-serif;
      font-size: 16px;
      outline: none;
      transition: border-color .2s;
      color: #1a1a3a;
    }
    .name-input:focus { border-color: #6c63ff; }
    .name-input::placeholder { color: #bbb; }

    /* ‚îÄ‚îÄ Date rows ‚îÄ‚îÄ */
    .date-list { display: flex; flex-direction: column; gap: 10px; }

    .date-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px 16px;
      border: 2px solid #e8eaf6;
      border-radius: 14px;
      cursor: pointer;
      transition: all .15s;
      user-select: none;
    }
    .date-row:hover { border-color: #c5c0ff; background: #f8f7ff; }
    .date-row.checked { border-color: #6c63ff; background: #f0eeff; }

    .checkbox {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      border: 2.5px solid #d0d0e8;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 15px;
      transition: all .15s;
    }
    .date-row.checked .checkbox {
      background: #6c63ff;
      border-color: #6c63ff;
      color: white;
    }

    .date-label { flex: 1; font-size: 16px; font-weight: 700; color: #1a1a3a; }
    .date-sub { font-size: 13px; color: #888; font-weight: 600; }

    .vote-count {
      font-size: 13px;
      font-weight: 700;
      background: #f0f0ff;
      color: #6c63ff;
      padding: 4px 10px;
      border-radius: 20px;
    }
    .vote-count.best {
      background: #eafff0;
      color: #28a745;
    }

    /* ‚îÄ‚îÄ Avatars ‚îÄ‚îÄ */
    .avatars { display: flex; gap: -4px; }
    .avatar {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #e8eaf6;
      color: #6c63ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 800;
      border: 2px solid white;
      margin-left: -4px;
    }
    .avatar:first-child { margin-left: 0; }

    /* ‚îÄ‚îÄ Button ‚îÄ‚îÄ */
    .btn {
      width: 100%;
      padding: 15px;
      background: #6c63ff;
      color: white;
      border: none;
      border-radius: 14px;
      font-family: 'Nunito', sans-serif;
      font-size: 17px;
      font-weight: 800;
      cursor: pointer;
      transition: all .15s;
      margin-top: 16px;
    }
    .btn:hover { background: #5a52e0; transform: translateY(-1px); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { background: #c5c0ff; cursor: not-allowed; transform: none; }
    .btn.success { background: #28a745; }

    .btn-small {
      padding: 8px 14px;
      background: #6c63ff;
      color: white;
      border: none;
      border-radius: 10px;
      font-family: 'Nunito', sans-serif;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: background .15s;
      white-space: nowrap;
    }
    .btn-small:hover { background: #5a52e0; }
    .btn-small.danger { background: #ff5252; }
    .btn-small.danger:hover { background: #e03e3e; }

    /* ‚îÄ‚îÄ Best banner ‚îÄ‚îÄ */
    .best-banner {
      background: linear-gradient(135deg, #eafff0, #d4ffde);
      border: 2px solid #a8e6b8;
      border-radius: 16px;
      padding: 16px 20px;
      font-size: 15px;
      color: #1a6630;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ‚îÄ‚îÄ Table ‚îÄ‚îÄ */
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th { padding: 8px 10px; color: #aab; font-size: 12px; text-transform: uppercase; letter-spacing: .05em; border-bottom: 2px solid #f0f0f8; }
    td { padding: 10px 10px; border-bottom: 1px solid #f0f0f8; color: #1a1a3a; font-weight: 600; }
    td.center { text-align: center; font-size: 18px; }

    /* ‚îÄ‚îÄ Admin ‚îÄ‚îÄ */
    .admin-toggle {
      text-align: center;
      font-size: 13px;
      color: #bbb;
      cursor: pointer;
      padding: 8px;
    }
    .admin-toggle:hover { color: #888; }
    #admin-section { display: none; }
    #admin-section.open { display: block; }

    .add-date-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .add-date-row input[type=date] {
      flex: 1;
      padding: 10px 12px;
      border: 2px solid #e8eaf6;
      border-radius: 12px;
      font-family: 'Nunito', sans-serif;
      font-size: 15px;
      outline: none;
      color: #1a1a3a;
    }
    .add-date-row input[type=date]:focus { border-color: #6c63ff; }

    .admin-date-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: #f8f8ff;
      border-radius: 10px;
      margin-bottom: 8px;
      font-weight: 700;
      color: #333;
    }

    .hint { font-size: 13px; color: #bbb; text-align: center; margin-top: 8px; }

    /* ‚îÄ‚îÄ Loader ‚îÄ‚îÄ */
    #loader {
      text-align: center;
      padding: 60px 0;
      font-size: 18px;
      color: #888;
    }
    .spinner {
      width: 36px; height: 36px;
      border: 3px solid #e8eaf6;
      border-top-color: #6c63ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 12px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .error-msg {
      background: #fff0f0;
      border: 2px solid #ffb3b3;
      border-radius: 12px;
      padding: 14px;
      color: #c00;
      font-size: 14px;
      text-align: center;
    }
  </style>
</head>
<body>
<div class="container">



  <div id="loader" style="display:none">
    <div class="spinner"></div>
    Chargement...
  </div>

  <div id="main-content" style="display:none">

    <!-- Header -->
    <div class="card">
      <div class="main-title" id="poll-title">üéâ Sondage Soir√©e</div>
      <div class="main-subtitle" id="poll-subtitle">Coche les dates o√π tu es disponible !</div>
    </div>

    <!-- Best date -->
    <div id="best-banner" class="best-banner" style="display:none">
      üèÜ <span id="best-text"></span>
    </div>

    <!-- Error -->
    <div id="error-msg" class="error-msg" style="display:none"></div>

    <!-- Vote form -->
    <div class="card" id="vote-card">
      <div class="card-title">Ton pr√©nom</div>
      <input class="name-input" type="text" id="name-input" placeholder="ex : Marie, Thomas..." />

      <div class="card-title" style="margin-top:20px">Tes disponibilit√©s</div>
      <div class="date-list" id="date-list">
        <p style="color:#bbb; font-size:14px; text-align:center; padding:16px 0">Aucune date pour l'instant‚Ä¶</p>
      </div>

      <button class="btn" id="submit-btn" onclick="submitVote()">‚úÖ Envoyer mes disponibilit√©s</button>
      <p class="hint">Si tu as d√©j√† vot√©, ta r√©ponse sera mise √† jour.</p>
    </div>

    <!-- Results table -->
    <div class="card" id="results-card" style="display:none">
      <div class="card-title">R√©capitulatif</div>
      <div class="table-wrap">
        <table id="results-table"></table>
      </div>
    </div>

    <!-- Admin toggle -->
    <div class="admin-toggle" onclick="toggleAdmin()">‚öôÔ∏è G√©rer les dates (organisateur)</div>
    <div class="card" id="admin-section">
      <div class="card-title">Ajouter une date</div>
      <div class="add-date-row">
        <input type="date" id="new-date-input" />
        <button class="btn-small" onclick="addDate()">+ Ajouter</button>
      </div>
      <div id="admin-date-list" style="margin-top:16px"></div>
      <div style="margin-top:16px; padding-top:16px; border-top:2px solid #f0f0f8">
        <div class="card-title">Participants</div>
        <div id="admin-participants-list"></div>
      </div>

      <div style="margin-top:16px; padding-top:16px; border-top:2px solid #f0f0f8">
        <div class="card-title">Titre du sondage</div>
        <div class="add-date-row">
          <input type="text" id="title-input" placeholder="ex: Soir√©e du boulot üéâ" style="flex:1;padding:10px 12px;border:2px solid #e8eaf6;border-radius:12px;font-family:'Nunito',sans-serif;font-size:15px;outline:none;color:#1a1a3a;" />
          <button class="btn-small" onclick="updateTitle()">‚úì OK</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIGURATION ‚Äî Modifie ces deux lignes !
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFIG = {
  API_KEY: "$2a$10$AEDYJ/LZpwO1YOsS/xzgNOyZ4xuCQbDp1FQxwOxvabJ/LlvGlxWsy",       // Ta Master Key JSONbin.io
  BIN_ID:  "69a07692d0ea881f40dc449b",       // Ton Bin ID (apr√®s cr√©ation)
};
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const BASE_URL = "https://api.jsonbin.io/v3/b";
let pollData = { title: "üéâ Sondage Soir√©e", subtitle: "Coche les dates o√π tu es disponible !", dates: [], responses: [] };
let myVotes = {};

// Auto-start
window.addEventListener('DOMContentLoaded', loadData);

function showLoader(v) {
  document.getElementById('loader').style.display = v ? 'block' : 'none';
}

function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = msg;
  el.style.display = msg ? 'block' : 'none';
}

async function loadData() {
  showLoader(true);
  showError('');
  try {
    const res = await fetch(`${BASE_URL}/${CONFIG.BIN_ID}/latest`, {
      headers: { 'X-Master-Key': CONFIG.API_KEY }
    });
    if (!res.ok) throw new Error("Impossible de charger les donn√©es (code " + res.status + ")");
    const json = await res.json();
    pollData = json.record;
    document.getElementById('main-content').style.display = 'flex';
    document.getElementById('main-content').style.flexDirection = 'column';
    document.getElementById('main-content').style.gap = '20px';
    render();
  } catch(e) {
    showError("‚ùå " + e.message);
    document.getElementById('main-content').style.display = 'flex';
  } finally {
    showLoader(false);
  }
}

async function saveData() {
  const res = await fetch(`${BASE_URL}/${CONFIG.BIN_ID}`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json', 'X-Master-Key': CONFIG.API_KEY },
    body: JSON.stringify(pollData)
  });
  if (!res.ok) throw new Error("Sauvegarde √©chou√©e (code " + res.status + ")");
}

function formatDate(d) {
  return new Date(d + 'T12:00:00').toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
}

function capitalise(s) { return s ? s[0].toUpperCase() + s.slice(1) : s; }

function getBestDate() {
  if (!pollData.dates.length || !pollData.responses.length) return null;
  let best = pollData.dates[0], bestCount = 0;
  pollData.dates.forEach(d => {
    const c = pollData.responses.filter(r => r.votes[d]).length;
    if (c > bestCount) { bestCount = c; best = d; }
  });
  return { date: best, count: bestCount };
}

function render() {
  // Title
  document.getElementById('poll-title').textContent = pollData.title || 'üéâ Sondage Soir√©e';
  document.getElementById('poll-subtitle').textContent = pollData.subtitle || 'Coche les dates o√π tu es disponible !';

  // Best date
  const best = getBestDate();
  const bb = document.getElementById('best-banner');
  if (best && best.count > 0) {
    const total = pollData.responses.length;
    document.getElementById('best-text').textContent =
      `Meilleure date : ${capitalise(formatDate(best.date))} ‚Äî ${best.count} sur ${total} disponible${best.count > 1 ? 's' : ''}`;
    bb.style.display = 'flex';
  } else {
    bb.style.display = 'none';
  }

  // Date list
  const list = document.getElementById('date-list');
  if (!pollData.dates.length) {
    list.innerHTML = '<p style="color:#bbb;font-size:14px;text-align:center;padding:16px 0">Aucune date pour l\'instant‚Ä¶</p>';
  } else {
    list.innerHTML = pollData.dates.map(d => {
      const voters = pollData.responses.filter(r => r.votes[d]);
      const isBest = best && d === best.date && best.count > 0;
      const isChecked = myVotes[d];
      const avatars = voters.map(r => `<div class="avatar" title="${r.name}">${r.name[0].toUpperCase()}</div>`).join('');
      return `
        <div class="date-row ${isChecked ? 'checked' : ''}" onclick="toggleVote('${d}')">
          <div class="checkbox">${isChecked ? '‚úì' : ''}</div>
          <div style="flex:1">
            <div class="date-label">${capitalise(formatDate(d))}</div>
          </div>
          <div class="avatars">${avatars}</div>
          <div class="vote-count ${isBest ? 'best' : ''}">${voters.length} ‚úì</div>
        </div>`;
    }).join('');
  }

  // Results table
  const rc = document.getElementById('results-card');
  if (pollData.responses.length > 0 && pollData.dates.length > 0) {
    rc.style.display = 'block';
    const table = document.getElementById('results-table');
    const shortDate = d => new Date(d + 'T12:00:00').toLocaleDateString('fr-FR', { day:'numeric', month:'short' });
    const headers = ['<th style="text-align:left">Pr√©nom</th>',
      ...pollData.dates.map(d => `<th>${shortDate(d)}</th>`)].join('');
    const rows = pollData.responses.map(r =>
      `<tr><td>${r.name}</td>${pollData.dates.map(d =>
        `<td class="center">${r.votes[d] ? '<span style="color:#28a745">‚úÖ</span>' : '<span style="color:#ddd">‚Äî</span>'}</td>`
      ).join('')}</tr>`
    ).join('');
    const totals = `<tr style="background:#f8f8ff"><td style="font-weight:800;color:#888;font-size:12px">TOTAL</td>${
      pollData.dates.map(d => {
        const c = pollData.responses.filter(r=>r.votes[d]).length;
        const ib = best && d === best.date && c > 0;
        return `<td class="center" style="font-weight:800;color:${ib?'#28a745':'#aab'}">${c}</td>`;
      }).join('')}</tr>`;
    table.innerHTML = `<thead><tr>${headers}</tr></thead><tbody>${rows}${totals}</tbody>`;
  } else {
    rc.style.display = 'none';
  }

  // Admin date list
  const adl = document.getElementById('admin-date-list');
  adl.innerHTML = pollData.dates.length ? pollData.dates.map(d => `
    <div class="admin-date-item">
      <span>${capitalise(formatDate(d))}</span>
      <button class="btn-small danger" onclick="removeDate('${d}')">‚úï Retirer</button>
    </div>`).join('') : '<p style="color:#bbb;font-size:14px">Aucune date ajout√©e.</p>';

  // Admin participants list
  const apl = document.getElementById('admin-participants-list');
  if (pollData.responses.length) {
    apl.innerHTML = pollData.responses.map(r => `
      <div class="admin-date-item">
        <span style="display:flex;align-items:center;gap:10px">
          <span style="width:30px;height:30px;border-radius:50%;background:#f0eeff;color:#6c63ff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:13px">${r.name[0].toUpperCase()}</span>
          ${r.name}
        </span>
        <button class="btn-small danger" onclick="removeParticipant('${r.name.replace(/'/g, "\\'")}')">‚úï Retirer</button>
      </div>`).join('');
  } else {
    apl.innerHTML = '<p style="color:#bbb;font-size:14px">Aucun participant pour l\'instant.</p>';
  }

  // Title input
  document.getElementById('title-input').value = pollData.title || '';
}

function toggleVote(d) {
  myVotes[d] = !myVotes[d];
  render();
}

async function submitVote() {
  const name = document.getElementById('name-input').value.trim();
  if (!name) { alert("Entre ton pr√©nom d'abord ! üòä"); return; }
  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Envoi en cours‚Ä¶';
  try {
    await loadData(); // refresh first
    const idx = pollData.responses.findIndex(r => r.name.toLowerCase() === name.toLowerCase());
    const newResp = { name: name, votes: myVotes, updatedAt: new Date().toISOString() };
    if (idx >= 0) pollData.responses[idx] = newResp;
    else pollData.responses.push(newResp);
    await saveData();
    btn.classList.add('success');
    btn.textContent = '‚úÖ R√©ponse enregistr√©e !';
    myVotes = {};
    document.getElementById('name-input').value = '';
    render();
    setTimeout(() => {
      btn.classList.remove('success');
      btn.textContent = '‚úÖ Envoyer mes disponibilit√©s';
      btn.disabled = false;
    }, 3000);
  } catch(e) {
    showError("Erreur lors de l'envoi : " + e.message);
    btn.textContent = '‚úÖ Envoyer mes disponibilit√©s';
    btn.disabled = false;
  }
}

async function addDate() {
  const d = document.getElementById('new-date-input').value;
  if (!d) return alert("S√©lectionne une date !");
  if (pollData.dates.includes(d)) return alert("Cette date est d√©j√† dans la liste !");
  pollData.dates = [...pollData.dates, d].sort();
  try {
    await saveData();
    render();
    document.getElementById('new-date-input').value = '';
  } catch(e) { showError("Erreur : " + e.message); }
}

async function removeParticipant(name) {
  if (!confirm(`Supprimer la r√©ponse de "${name}" ?`)) return;
  pollData.responses = pollData.responses.filter(r => r.name !== name);
  try { await saveData(); render(); } catch(e) { showError("Erreur : " + e.message); }
}

async function removeDate(d) {
  if (!confirm(`Supprimer la date "${capitalise(formatDate(d))}" ?`)) return;
  pollData.dates = pollData.dates.filter(x => x !== d);
  pollData.responses = pollData.responses.map(r => { const v={...r.votes}; delete v[d]; return {...r,votes:v}; });
  try { await saveData(); render(); } catch(e) { showError("Erreur : " + e.message); }
}

async function updateTitle() {
  const t = document.getElementById('title-input').value.trim();
  if (!t) return;
  pollData.title = t;
  try { await saveData(); render(); } catch(e) { showError("Erreur : " + e.message); }
}

function toggleAdmin() {
  const s = document.getElementById('admin-section');
  s.classList.toggle('open');
}
</script>
</body>
</html>
